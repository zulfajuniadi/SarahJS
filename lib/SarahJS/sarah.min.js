define(["lodash"],function(){var a={},b={};b.Loaded={},b.Persistance={},b.onClose=[],b.onEnter=[],b.onAway=[],b.onBack=[],b.onHidden=[],b.onVisible=[],b.Collections={},b.Templates={},a.pubsub={};var c=a.pubsub,d={};d.getTemplateVars=function(a){return _.uniq(_.compact(_.flatten((a.match(/\{\{#?[\w].+?\}\}|\{\{#if?[\w].+?\}\}/g)||[]).map(function(a){return a.replace(/#[\w.]+\s/,"").split(" ")})).map(function(a){return a.replace(/\{\{|\}\}/g,"").replace("../","")}).map(function(a){return a.indexOf('"')>-1||a.indexOf("'")>-1||_.keys(Handlebars.helpers).indexOf(a)>-1||"else"===a?void 0:a})))},d.cleanUrl=function(a){return a=a.replace("http://","HTTPCOLSLASH").replace("https://","HTTPSCOLSLASH").replace("//","/").replace("HTTPCOLSLASH","http://").replace("HTTPSCOLSLASH","https://")},d.isNumber=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},d.isString=function(a){return a&&a.constructor===String},d.isObject=function(a){return a&&a.constructor===Object||!1},d.isArray=function(a){return"undefined"==typeof a?!1:"function"==typeof a.forEach&&"function"==typeof a.map},d.isFunction=function(a){return"function"==typeof a?!0:void 0},d.isEmail=function(a){if(d.isString(a)){var b=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test(a)}return!1},d.autoCast=function(a){var b=!1;return d.isObject(a)&&d.isArray(a)||(a=[a],b=!0),a=_.map(a,function(a){var c,b={"true":!0,"false":!1,undefined:void 0,"null":null,NaN:0/0};if(a instanceof Date)return a;if(d.isNumber(a))return Number(a);for(c in b)if(a===c)return b[c];return a}),b?a[0]:a},d.serializeForm=function(a){for(var b={},c=a.elements,d=0;d<c.length;d++){var e=c[d];if(e.name){var f=e.value||null;b[e.name]?(b[e.name]=[b[e.name]],b[e.name].push(f)):b[e.name]=f}}return b},d._doDeepPluck=function(a,b){var c=this;return _.map(a,function(a,e){if(void 0!==a&&null!==a){if(d.isArray(b)){if(b.indexOf(a)>-1||b.indexOf(e)>-1)return a}else if(b===a||e===b)return a;return d.isObject(a)||d.isArray(a)?c._doDeepPluck(a,b):void 0}})},d.deepPluck=function(a,b){return d.cleanArray(_.flatten(this._doDeepPluck(a,b)))},d.toTitleCase=function(a){return a.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})},d.sumArray=function(a){if(d.isArray(a)||d.isObject(a)){var b=0;return _.each(a,function(a){var a=parseInt(a,10);isNaN(a)||(b+=a)}),b}return 0},d.isBoolean=function(a){return["true","false",!0,!1].indexOf(a)>-1?!0:!1},d.cleanArray=function(a){for(var b=0;b<a.length;b++)("undefined"==typeof a[b]||null===a[b]||""===a[b])&&(a.splice(b,1),b--);return a},d.genId=function(){function a(){return(0|65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},d.publish=function(a,b){for(var e=c[a],f=e?e.length:0;f--;)e[f].apply(d,[b]||[])},d.subscribe=function(a,b){return c[a]||(c[a]=[]),c[a].push(b),[a,b]},d.unsubscribe=function(a,b){c[a]=_.without(c[a],b)},a.bindElement={};var i,e={},f=document,g="localStorage",h="__storejs__";e.disabled=!1,e.set=function(){},e.get=function(){},e.remove=function(){},e.clear=function(){},e.transact=function(a,b,c){var d=e.get(a);null==c&&(c=b,b=null),"undefined"==typeof d&&(d=b||{}),c(d),e.set(a,d)},e.getAll=function(){},e.serialize=function(a){return JSON.stringify(a)},e.deserialize=function(a){if("string"!=typeof a)return void 0;try{return JSON.parse(a)}catch(b){return a||void 0}};var j=function(){try{return g in window&&window[g]}catch(a){return!1}},k=function(a){return function(){var b=Array.prototype.slice.call(arguments,0);b.unshift(i),m.appendChild(i),i.addBehavior("#default#userData"),i.load(g);var c=a.apply(e,b);return m.removeChild(i),c}},l=function(a){return a.replace(p,"___")};if(j())i=window[g],e.set=function(a,b){return void 0===b?e.remove(a):(i.setItem(a,e.serialize(b)),b)},e.get=function(a){return e.deserialize(i.getItem(a))},e.remove=function(a){i.removeItem(a)},e.clear=function(){i.clear()},e.getAll=function(){for(var a={},b=0;b<i.length;++b){var c=i.key(b);a[c]=e.get(c)}return a};else if(f.documentElement.addBehavior){var m,n;try{n=new ActiveXObject("htmlfile"),n.open(),n.write('<script>document.w=window</script><iframe src="/favicon.ico"></iframe>'),n.close(),m=n.w.frames[0].document,i=m.createElement("div")}catch(o){i=f.createElement("div"),m=f.body}var p=new RegExp("[!\"#$%&'()*+,/\\\\:;<=>?@[\\]^`{|}~]","g");e.set=k(function(a,b,c){return b=l(b),void 0===c?e.remove(b):(a.setAttribute(b,e.serialize(c)),a.save(g),c)}),e.get=k(function(a,b){return b=l(b),e.deserialize(a.getAttribute(b))}),e.remove=k(function(a,b){b=l(b),a.removeAttribute(b),a.save(g)}),e.clear=k(function(a){var b=a.XMLDocument.documentElement.attributes;a.load(g);for(var d,c=0;d=b[c];c++)a.removeAttribute(d.name);a.save(g)}),e.getAll=k(function(a){for(var f,b=a.XMLDocument.documentElement.attributes,c={},d=0;f=b[d];++d){var g=l(f.name);c[f.name]=e.deserialize(a.getAttribute(g))}return c})}try{e.set(h,h),e.get(h)!=h&&(e.disabled=!0),e.remove(h)}catch(o){e.disabled=!0}d.Store=e,d.getBinding=function(b){return a.bindElement[b]},d.onElementReady=function(a,b){var c=document.querySelectorAll(a);if(c.length>0)b(c[0]);else var d=setInterval(function(){c=document.querySelectorAll(a),c.length>0&&(clearInterval(d),b(c[0]))},15)};var q=function(a,b,c){var d=this;d.name=a,d.watch=b,d.lastResult=null,d.callback=c},r=function(){var a=this;this.watchList=[],this.Timeout,a.interval=15,a.loopDuration=0,this.start()};r.prototype.loop=function(a,b){var c=this,b=b||!1;if(c.watchList.length>0){var d;c.Timeout=setTimeout(function(){var e=(new Date).getTime();c.watchList=c.watchList.map(function(b){return d=JSON.stringify(b.watch()),d&&d!==b.lastResult&&(b.callback(JSON.parse(d),JSON.parse(b.lastResult)),b.lastResult=d),b});var f=(new Date).getTime()-e;f!==c.loopDuration&&(c.loopDuration=f),b===!1&&c.start()},a)}else to=setTimeout(function(){c.watchList.length>0&&(c.loop(),clearTimeout(to))},100)},r.prototype.setInterval=function(a){this.interval=a},r.prototype.getInterval=function(){return this.interval+this.loopDuration},r.prototype.start=function(){var a=this.getInterval();return this.loop(a),!0},r.prototype.stop=function(){return clearTimeout(this.Timeout),!0},r.prototype.reset=function(){this.stop(),this.watchList=[],this.start()},r.prototype.register=function(a,b,c){var b=b||"";if(d.isFunction(b)&&d.isFunction(c)){var e=new q(a,b,c);return this.watchList.push(e),e}return null},r.prototype.unregister=function(a){this.watchList=_.without(this.watchList,_.where(this.watchList,{name:a}))},r=new r;var s=function(){this.data={},this.flashTimeout=5e3};s.prototype._flash=[],s.prototype.setFlash=function(a){var b=this;b._flash.push(a),setTimeout(function(){b.unsetFlash(a)},b.flashTimeout)},s.prototype.unsetFlash=function(a){this._flash=_.without(this._flash,a)},s.prototype.getFlash=function(){return this._flash||[]},s.prototype.set=function(a,b){this.data[a]=b},s.prototype.remove=function(a){a&&delete this.data[a]},s.prototype.equals=function(a,b){if(a){var c=this.get(a);if(c===b)return!0}return!1},s.prototype.get=function(a,b){return this.data[a]||b},s.prototype.toggle=function(a){return"undefined"==typeof this.data[a]&&(this.data[a]=!1),this.data[a]=!this.data[a]||!1,this.data[a]},s.prototype.has=function(a,b){return void 0===this.data[a]&&(this.data[a]=[]),this.data[a].indexOf(b)>-1?!0:!1},s.prototype.push=function(a,b){var c=this;void 0===this.data[a]&&(this.data[a]=[]),this.data[a].map&&(b.map?b.forEach(function(b){c.data[a].push(b)}):c.data[a].push(b))},s.prototype.pull=function(a,b){this.data[a].map&&(this.data[a]=_.without(this.data[a],b))},setTimeout(function(){d.publish("LOAD:SESSION")},1),s=new s,a.tmplVars={};var u=function(a){var b=this;this._name=a.name,this._html=a.html,this._url=a.url,this._outlets=[],this._attributes={},this._persistant=!1,this._partials=[],r.register("_eventsList",function(){return this._eventsList},function(){b.renderAll(!0)}),d.subscribe("SETLAYOUT:"+this._name,function(a){"undefined"!=typeof a?b.setOutlet(a):b.renderAll})};u.prototype.setOutlet=function(a,b){b&&(this._persistant=!0),-1===this._outlets.indexOf(a)&&this._outlets.push(a),this.renderAll()},u.prototype.removeOutlet=function(a){r.unregister(self._name),$(a).empty(),this._outlets=_.without(this._outlets,a)},u.prototype.removeOutlets=function(){var a=this;this._outlets.forEach(function(b){a.removeOutlet(b)})},u.prototype.renderAll=function(){var a=this;clearTimeout(a.bubbleTimer),a.bubbleTimer=setTimeout(function(){"function"==typeof a.beforeRender&&a.beforeRender.call(a),a._outlets.forEach(function(b){d.onElementReady(b,function(b){b.innerHTML="",a.renderToElement(b),a.bindEvents(b),a._partials.forEach(function(a){d.publish("SETLAYOUT:"+a.Template._name,a.outlet)})})}),"function"==typeof a.afterRender&&a.afterRender.call(a)},100)},u.prototype.partials=function(a){var b=this;a.forEach(function(a){-1===b._partials.indexOf(a)&&b._partials.push(a)})},u.prototype.attributes=function(a){var b=this;return r.unregister(b._name),_.each(a,function(a,c){d.isFunction(a)?r.register(b._name,a,function(){b._attributes[c]=a(),b.renderAll(!0)}):b._attributes[c]=a,b.renderAll(!0)}),b},u.prototype.bindEvents=function(b){_.each(this._eventsList,function(c,e){e.split(",").forEach(function(e){var f=e.trim().split(/\s+/),g=b.querySelectorAll(f[1]);if(g.length>0)for(var h=0;h<g.length;++h){var i=g[h],j=function(b){var e=this.getAttribute("data-binding"),g={};e&&(g=a.bindElement[e]),"submit"===f[0]&&"FORM"===i.tagName&&(g=d.serializeForm(i)),c.apply(g,[b,i])};i.addEventListener?i.addEventListener(f[0],j):i.attachEvent("on"+f[0],j)}})})},u.prototype._eventsList={},u.prototype.events=function(a){var b=this;_.each(a,function(a,c){d.isFunction(a)&&(b._eventsList[c]=a)})},u.prototype.render=function(b){var e={};return e=b?b:this._attributes,e=_.extend({},e,{bind:function(b){var c=d.genId();return a.bindElement[c]=b," rel=boundedData data-binding = "+c}}),_.template(this._html,e)},u.prototype.renderToElement=function(a){a.innerHTML=this.render(),a.className=this._name},a.db=a.db||{};var v=function(b,c){this.name=b,this.persistance={},this.data=a.db[b]=[],this.init(c),this.revertHistory=[]};v.prototype.checksum=null,v.prototype._softDelete=!1,v.prototype.get=function(b){return a.db[this.name].filter(function(a){return a._id===b&&("0"===a.deletedAt||null===a.deletedAt)})[0]||null},v.prototype.getAll=function(){return d.isFunction(this.getFilter)?a.db[this.name].filter(this.getFilter):a.db[this.name].filter(function(a){return null===a.deletedAt||"0"===a.deletedAt})},v.prototype.filter=function(a){var b=this.getAll();return d.isFunction(a)?b.filter(a):b},v.prototype.where=function(b){var b=b||{};return this._softDelete&&(b.deletedAt=null),_.where(a.db[this.name],b)},v.prototype.findWhere=function(a){var b=this.getAll();return _.findWhere(b,a)},v.prototype.insert=function(b,c){var e=this,c=c||!1,f=function(b){if(void 0===b._id&&(b._id=d.genId(),b.createdAt=new Date,b.updatedAt=new Date,b.deletedAt=null),a.db[e.name].push(b),!c){var f=_.extend({},b);f.r={CollectionName:e.name,_id:b._id,operation:"INSERT"},d.publish("COLLECTION:INSERT:"+e.name,f),s.setFlash({type:"notification",message:"Data inserted successfully.",level:"success"})}return b};if(b){if(void 0===b.length)return f(b);b.forEach(function(a){f(a)})}},v.prototype.save=function(a,b){return"undefined"==typeof a._id||null===a._id&&""===a._id?this.insert(a,b):this.update({_id:a._id},a)},v.prototype.merge=function(b,c){var e=this,c=c||!1,f=function(b){var f=e.get(b._id);if(f?a.db[e.name].splice(a.db[e.name].indexOf(f),1,b):a.db[e.name].push(b),!c){var g=_.extend({},b);g.r={CollectionName:e.name,_id:b._id,operation:"INSERT"},d.publish("COLLECTION:INSERT:"+e.name,g),s.setFlash({type:"notification",message:"Data inserted successfully.",level:"success"})}return b};if(b){if(void 0===b.length)return f(b);b.forEach(function(a){f(a)})}},v.prototype.update=function(b,c,e){var f=this,e=e||!1,g=this.findWhere(b),h=_.extend({},g);if(g){var i=a.db[this.name].indexOf(g),j=_.extend({},g,c);j.updatedAt=new Date,a.db[this.name].splice(i,1,j)}if(!e){var k=_.extend({},j);k.r={CollectionName:this.name,_id:g._id,operation:"UPDATE"},f.revertHistory.push(h),d.publish("COLLECTION:UPDATE:"+f.name,k),s.setFlash({type:"notification",message:"Data updated successfully.",level:"success"})}return g},v.prototype.first=function(){return 0!==this.getAll().length?this.getAll()[0]:void 0},v.prototype.last=function(){return 0!==this.getAll().length?this.getAll()[this.getAll().length-1]:void 0},v.prototype.deepPluck=function(a,b){"undefined"==typeof b&&(b=a,a=this.getAll());var e=d.deepPluck(a,b);return e},v.prototype.deepFilter=function(a,b,c){var e=this,f=[];if(a instanceof Array)for(var g=0;g<a.length;g++){var h=e.deepFilter(a[g],b,c);null!==h&&f.push(h)}else for(var i in a){if(i===b)if(d.isFunction(c)){if(c(a[i]))return a}else if(a[i]===c)return a;if(a[i]instanceof Object||a[i]instanceof Array){var h=e.deepFilter(a[i],b,c);null!==h&&f.push(h)}}return _.flatten(f)},v.prototype.inCollection=function(a,b,c,e){var f=this;if("undefined"==typeof a||null===a||a===[])return!1;if(d.isArray(a)||d.isObject(a)){if(a[b]===c)return e.unshift(a),!0;var g=_.filter(a,function(a){return f.inCollection(a,b,c,e)});return g.length>0?(d.isObject(a)&&e.push(a),!0):!1}return!1},v.prototype.getProperties=function(a,b,c){var d=this,e={},f=[],g=[];if("undefined"==typeof c)c=b,b=a,g=d.getAll().filter(function(a){return d.inCollection(a,b,c,f)});else{var h=d.get(a);h&&d.inCollection(h,b,c,f)&&g.push(h)}return g.length>0?(e.Collection=g[0],e.data=f[0],e.parent=f[1],e.paths=f,e):void 0},v.prototype.remove=function(b,c){var e=this,c=c||!1,f=e.findWhere(b);if(f){var g=_.extend({},f);if(e._softDelete?(f.deletedAt=new Date,e.update({_id:f.id},f,!0)):a.db[e.name].splice(a.db[e.name].indexOf(f),1),!c){var h=_.extend({},g);h.r={CollectionName:e.name,_id:f._id,operation:"REMOVE"},e.revertHistory.push(g),d.publish("COLLECTION:REMOVE:"+e.name,h),s.setFlash({type:"notification",message:"Data removed successfully.",level:"success"})}}},v.prototype.revert=function(a){var b=this;switch(a.operation){case"INSERT":b.remove({_id:a._id},!0);case"UPDATE":b.update({_id:a._id},_.where(b.revertHistory,{_id:a._id}).pop(),!0);case"REMOVE":b.insert(_.where(b.revertHistory,{_id:a._id}).pop(),!0)}},v.prototype.export=function(){return _.where(a.db[this.name],{isFixture:void 0})},v.prototype.purge=function(){if(confirm('Are you sure you want to purge "'+this.name+'" Collection?')){var a=this,b=this.getAll();b.forEach(function(b){a.remove({name:b.name})})}},v.prototype.import=function(b,c){var c=c||!0;return c&&(a.db[this.name]=b),a.db[this.name]},v.prototype.init=function(a){var c=this;a.fixtures&&a.fixtures.forEach(function(a){a.isFixture=!0,c.insert(a,!0)}),a.plugins&&_.each(a.plugins,function(a,d){if("function"!=typeof b.Persistance[d]){var e='Plugin for database backend "'+d+'" is unavailable. Did you load it?';throw new Error(e)}c.persistance[d]=new b.Persistance[d](c.name,a)}),a.softDelete&&(this._softDelete=a.softDelete),setTimeout(function(){d.publish("LOAD:COLLECTION:"+c.name)},1)},function(a){var b=[],c={},d="routie",e=a[d],f=function(a,b){this.name=b,this.path=a,this.keys=[],this.fns=[],this.params={},this.regex=g(this.path,this.keys,!1,!1)};f.prototype.addHandler=function(a){this.fns.push(a)},f.prototype.removeHandler=function(a){for(var b=0,c=this.fns.length;c>b;b++){var d=this.fns[b];if(a==d)return this.fns.splice(b,1),void 0}},f.prototype.run=function(a){for(var b=0,c=this.fns.length;c>b;b++)this.fns[b].apply(this,a)},f.prototype.match=function(a,b){var c=this.regex.exec(a);if(!c)return!1;for(var d=1,e=c.length;e>d;++d){var f=this.keys[d-1],g="string"==typeof c[d]?decodeURIComponent(c[d]):c[d];f&&(this.params[f.name]=g),b.push(g)}return!0},f.prototype.toURL=function(a){var b=this.path;for(var c in a)b=b.replace("/:"+c,"/"+a[c]);if(b=b.replace(/\/:.*\?/g,"/").replace(/\?/g,""),-1!=b.indexOf(":"))throw new Error("missing parameters for url: "+b);return b};var g=function(a,b,c,d){return a instanceof RegExp?a:(a instanceof Array&&(a="("+a.join("|")+")"),a=a.concat(d?"":"/?").replace(/\/\(/g,"(?:/").replace(/\+/g,"__plus__").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(a,c,d,e,f,g){return b.push({name:e,optional:!!g}),c=c||"",""+(g?"":c)+"(?:"+(g?c:"")+(d||"")+(f||d&&"([^/.]+?)"||"([^/]+?)")+")"+(g||"")}).replace(/([\/.])/g,"\\$1").replace(/__plus__/g,"(.+)").replace(/\*/g,"(.*)"),new RegExp("^"+a+"$",c?"":"i"))},h=function(a,d){var e=a.split(" "),g=2==e.length?e[0]:null;a=2==e.length?e[1]:e[0],c[a]||(c[a]=new f(a,g),b.push(c[a])),c[a].addHandler(d)},i=function(a,b){if("function"==typeof b)h(a,b),i.reload();else if("object"==typeof a){for(var c in a)h(c,a[c]);i.reload()}else"undefined"==typeof b&&i.navigate(a)};i.lookup=function(a,c){for(var d=0,e=b.length;e>d;d++){var f=b[d];if(f.name==a)return f.toURL(c)}},i.remove=function(a,b){var d=c[a];d&&d.removeHandler(b)},i.removeAll=function(){c={},b=[]},i.navigate=function(a,b){b=b||{};var c=b.silent||!1;c&&n(),setTimeout(function(){window.location.hash=a,c&&setTimeout(function(){m()},1)},1)},i.noConflict=function(){return a[d]=e,i};var j=function(){return window.location.hash.substring(1)},k=function(a,b){var c=[];return b.match(a,c)?(b.run(c),!0):!1},l=i.reload=function(){for(var a=j(),c=0,d=b.length;d>c;c++){var e=b[c];if(k(a,e))return}},m=function(){a.addEventListener?a.addEventListener("hashchange",l,!1):a.attachEvent("onhashchange",l)},n=function(){a.removeEventListener?a.removeEventListener("hashchange",l):a.detachEvent("onhashchange",l)};m(),a[d]=i}(window);var w=window.routie;delete window.routie;var x=function(a){var c=b.Config=a||{},d=(a.plugins||[]).map(function(b){return(a.base||"")+"plugins/"+b+".min"});return require(d,function(){setTimeout(function(){require([a.app])},1)}),a.depsInterval=a.depsInterval||100,y.Deps.setInterval(a.depsInterval),c},y={Runtime:b,Utils:d,Cache:a,Deps:r,Session:s,Collection:v,Collections:b.Collections,Templates:b.Templates,Template:u,Router:w,Configure:x};return setInterval(function(){var b=document.querySelectorAll("[data-binding]"),c=Object.keys(a.bindElement);_.map(b,function(b){var d=b.getAttribute("data-binding");-1===c.indexOf(d)&&delete a.bindElement[d]})},500),window.onbeforeunload=function(){y.Runtime.onClose.forEach(function(a){"function"==typeof a&&a()})},y});